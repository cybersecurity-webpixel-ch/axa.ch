class e{isLoaded=!1;#e=[];setLoaded(e=!0){this.isLoaded=e,this.executeCallbacks()}executeCallbacks(){const e=[...this.#e];this.#e=[],e.forEach((e=>e()))}addCallbackWhenReady(e){this.#e.push(e),this.isLoaded&&this.executeCallbacks()}}const t=(e,t="log")=>(window.location.href.includes("bifrost-debug=true")||"true"===localStorage["bifrost-debug"])&&console[t](`[bifrost] (${performance.now()}ms): ${e}`);class s extends e{#t={};#s=null;#i={};#o={};#r=!1;static STORE_KEY="bifrost-store-";static EXPIRATION_KEY="bifrost-expiration-time";static DEFAULT_NAMESPACE="common";static RESERVED_KEY={"browser_in-app":()=>document.body.classList.contains("in-app"),browser_context:()=>document.body.getAttribute("data-request-context")};#n(e){if(this.#r)return this.#o[e];let t=localStorage.getItem(s.EXPIRATION_KEY);if("string"!=typeof t){const e=JSON.stringify({});try{localStorage.setItem(s.EXPIRATION_KEY,e)}catch(e){}t=localStorage.getItem(s.EXPIRATION_KEY)||e}try{this.#o=JSON.parse(t)}catch(e){}return this.#r=!0,this.#o[e]}#a(e){return"number"==typeof this.#n(e)?localStorage:sessionStorage}#c(e,t,i,o=!0,r){if(!e||!t||void 0===i)return!1;const n=`${t}_${e}`;if("number"==typeof r&&r>0){this.#o[n]=r;try{localStorage.setItem(s.EXPIRATION_KEY,JSON.stringify(this.#o))}catch(e){}}if(void 0!==this.#t[n]?this.#l(i)?this.#t[n]=this.#h(Array.isArray(i)&&Array.isArray(this.#t[n])?[...i]:{...this.#t[n],...i}):this.#t[n]=i:this.#l(i)?this.#t[n]=this.#h(Array.isArray(i)?[...i]:{...i}):this.#t[n]=this.#h(i),!o)return!0;let a=this.#t[n];return a=this.#l(a)&&a?JSON.stringify(a):a,this.#a(n).setItem(`${s.STORE_KEY}${n}`,a),!0}expired=(e,t=s.DEFAULT_NAMESPACE,i=0)=>{if(!e)return 0;const o=this.#n(`${t}_${e}`)||0;return 0===o?0:0===i?o:o<i?1:0};get=(e,i=s.DEFAULT_NAMESPACE)=>{if(!e)return!1;const o=`${i}_${e}`;if("function"==typeof s.RESERVED_KEY[o])return s.RESERVED_KEY[o](this);const r=this.#a(o).getItem(`${s.STORE_KEY}${o}`);if(!this.#t[o]&&r)try{this.#t[o]=JSON.parse(r)}catch(e){this.#t[o]=r}const n=this.#t[o];return t(`get: key=${e}, namespace=${i}, value exists=${!!n}`),this.#l(n)?this.#h(Array.isArray(n)?[...n]:{...n}):this.#h(n)};getAsync=(e,t,s)=>(this.isLoaded?s(this.get(e,t)):this.addCallbackWhenReady((()=>{s(this.get(e,t))})),!0);clean=(e,i)=>{if(!e||!i)return!1;const o=`${i}_${e}`,r=this.#t[o];if(this.#t[o]=null,delete this.#t[o],this.#a(o).removeItem(`${s.STORE_KEY}${o}`),this.expired(e,i)){delete this.#o[o];try{localStorage.setItem(s.EXPIRATION_KEY,JSON.stringify(this.#o))}catch(e){}t(`clean(${e},${i})`)}const n=this.#u(e,i);return void 0!==r&&n.forEach(((t,s)=>this.#i[`${e}_${i}_${s}`]&&t(r,"clean"))),!0};subscribe=(e,s,i,o,r)=>{const n=this.#u(e,s);n.push(i),o&&(this.#i[`${e}_${s}_${n.length-1}`]=!0),t(`subscribe(${e},${s}, cb, onClean=${o}, onExists=${r})`);const a=this.get(e,s);return r&&e&&void 0!==a&&(t(`subscribe(${e},${s}) - key found, executing callback...`),i(a)),!0};publish=(e,s,i,o=!0,r=0)=>{let n=this.#c(e,s,i,o,r);return n&&(t(`publish(${e},${s},${JSON.stringify(i)})`),this.#u(e,s).forEach(((i,o)=>{const r=this.get(e,s);t(`publish: executing callback ${o} for (${e},${s},${JSON.stringify(r)})`),i(r)}))),n};cleanAll=(e=sessionStorage)=>{const i=Object.keys(e).filter((e=>0===e.indexOf(s.STORE_KEY)));t(`cleanAll(${i})`),i.forEach((e=>{const[t,i]=e.split("_"),o=t.slice(s.STORE_KEY.length);this.clean(i,o)}))};#u(e,t){const s=`${t}_${e}`;this.#g(s);const{[s]:{subs:i}}=this.#s;return i}#g(e){this.#s?this.#s[e]||(this.#s[e]={subs:[]}):this.#s={[e]:{subs:[]}}}#h(e){let t=e;return t&&this.#l(t)?(Object.keys(t).forEach((e=>{const s=t[e];t[e]=this.#l(s)&&this.#d(s)||s})),Array.isArray(t)?[...t]:{...t}):t}#d(e){return Array.isArray(e)?this.#h([...e]):this.#h({...e})}#l(e){return"object"==typeof e&&null!==e}}class i{#k="";constructor(e){e&&this.merge(e)}merge(e){Object.keys(e).forEach((t=>{const{[t]:s}=e;"token"===t?this.#k=s:this[t]||(this[t]=s)}))}set bifrost_token(e){this.#k=e}get token(){return console.warn("@Deprecation warning Bifrost: please use getValidToken() method to retrieve current valid token"),this.#k}getValidToken(){return this.#k}}const o="SAT_CH_AXACH",r="SAT_CH_AXACH-NEXTREL";class n{isNextrel=!1;getTokenIfInCookie(){return this.getCookieToken()||""}setIsNextrel(){this.isNextrel=!0}getIsNextrel(){return this.isNextrel}getTokenIfPresent(){return this.getCookieToken()}getPersistedData(){return JSON.parse(sessionStorage.getItem(this.getPersistedDataKey())||"{}")}getLoginTries(){return parseInt(sessionStorage.getItem(this.getTriesKey())||"0",10)||0}setAccessToken(e,t){sessionStorage.removeItem(this.getPersistedDataKey()),sessionStorage.removeItem(this.getTriesKey()),e!==t&&this.updateCookieWithToken(e)}setRefreshToken(e){sessionStorage.setItem(this.getHasTokenRefreshedKey(),"1"),this.updateCookieWithToken(e)}updateCookieWithToken(e){this.setTokenToCookie(this.isNextrel?r:o,e)}setPersistedData(e){sessionStorage.setItem(this.getPersistedDataKey(),JSON.stringify(e))}getLoginPath(){return this.preparePartialUrl("enter/axa-ch/customer")}getRefreshPath(){return this.preparePartialUrl("rest/amur/public-enter/v1/axa-ch/refresh")}getLogoutPath(){return this.preparePartialUrl("enter/axa-ch/logout")}preparePartialUrl(e){return this.isNextrel?""+e.replace("/axa-ch","/axa-ch-nextrel"):e}cleanupAfterLogout(){this.cleanup()}cleanup(){sessionStorage.removeItem(this.getTriesKey()),sessionStorage.removeItem(this.getPersistedDataKey()),sessionStorage.removeItem(this.getHasTokenRefreshedKey())}setLoginTries(e){sessionStorage.setItem(this.getTriesKey(),""+e)}getPersistedDataKey(){return this.isNextrel?"axa-ch-nextrel-amur-persisted-data":"axa-ch-amur-persisted-data"}getTriesKey(){return this.isNextrel?"amur-nextrel-oauth-login-tries":"amur-oauth-login-tries"}getHasTokenRefreshedKey(){return this.isNextrel?"amur-nextrel-session-storage-has-refreshed":"amur-session-storage-has-refreshed"}getCookieToken(){return this.getTokenFromCookie(this.isNextrel?r:o)}getTokenFromCookie(e){const t=e+"=",s=decodeURIComponent(document.cookie).split(";");for(let e=0;e<s.length;e++){let i=s[e];for(;" "===i.charAt(0);)i=i.substring(1);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return""}setTokenToCookie(e=o,t){const s=new Date;s.setTime(s.getTime()+324e5);const i="expires="+s.toUTCString();document.cookie=`${e}=${t}; ${i}; path=/`}}const a=/^\s*Bearer\s+/;class c extends e{tokenObject=null;env=null;defaultInterval=3e5;isRefreshActive=!1;hasTokenToDoLogout=!1;utcDateHourDiffer=0;timeoutTokenCheck;storeCleanAll=()=>{};inactivitychecker;static cleanBearerToken(e=""){return e?e.replace(a,""):e}constructor(e,t=3e5){super(),this.inactivitychecker=e,this.defaultInterval=this.refreshInterval=t,this.inactivitychecker.addLogoutFn((()=>{this.logout()})),this.env=new n}setUtcDateHourDiffer(e){this.utcDateHourDiffer=e}getHasTokenToDoLogout(){return this.hasTokenToDoLogout}activateRefresh(){this.isRefreshActive||(this.isRefreshActive=!0,this.inactivitychecker.notifyInactivityAfterMs(this.refreshInterval,(()=>{const e=this.tokenObject?.getValidToken();fetch(`${window.location.protocol}//api.${window.location.hostname.replace("www.","")}/${this.env?.getRefreshPath()}`,{method:"PUT",headers:{"x-axa-apikey":"2eb5d17d-1b1f-4308-a68e-ca34a8196ee0","Content-Type":"application/json"},body:e}).then((e=>{if(!e.ok)throw Error("BIFROST: API call invalid. Force logout");return e.text()})).then((e=>{this.refreshToken(e)})).catch((()=>{this.logout()}))})))}setIsNextrel(){this.env?.setIsNextrel()}getIsNextrel(){return this.env?.getIsNextrel()}triggerTimeoutPeriodicalCheck(){this.timeoutTokenCheck=setTimeout((()=>{this.periodicallyCheckToken()}),5e3)}periodicallyCheckToken(){if(this.isToLogout())return this.logout(),clearTimeout(this.timeoutTokenCheck),!1;this.triggerTimeoutPeriodicalCheck()}login(e,s={}){const i=this.env?.getTokenIfInCookie()||"",o=c.cleanBearerToken(i);let r=this.env?.getLoginTries()||0;if(t(`login(...), cookieToken=${o}, isNextrel=${this.getIsNextrel()}`),o){let t={};try{t=this.env?.getPersistedData()}catch{}"object"==typeof s&&null!==s&&(t={...s,...t}),this.env?.setAccessToken(o,i),this.createTokenObject(t),null!==this.tokenObject&&(this.tokenObject.bifrost_token=o);const r=this.getExpTimeOfToken(o),n=new Date(1e3*r),a=new Date,c=Math.abs(n.getTime()-a.getTime())||1,l=Math.abs(c/2-2),{defaultInterval:h}=this;this.refreshInterval=l>h?l:h,this.addCallbackWhenReady((()=>{this.activateRefresh(),this.callCallbackIfTokenNotExpired(e),this.triggerTimeoutPeriodicalCheck()}))}else{if(r<3){try{this.env?.setPersistedData(s)}catch{throw Error("Cannot stringify the passed data to persist. Maybe a cylic object has been passed")}window.location.replace(this.getUrl(this.env?.getLoginPath()||""))}else this.cleanupSessionStorage(e);this.env?.setLoginTries(r+1)}}getExpTimeOfToken(e){const[,t]=e.split("."),{exp:s}=JSON.parse(atob(t));return s}isToLogout(e=this.tokenObject?.getValidToken()){return!e||Math.floor(Date.now()/1e3)+60*this.utcDateHourDiffer*60>Math.floor(this.getExpTimeOfToken(e))}callCallbackIfTokenNotExpired(e){this.hasTokenToDoLogout=!0;const t=this.tokenObject?.getValidToken();if(t)return this.isToLogout(t)?(this.logout(),!1):void e({...this.tokenObject,getValidToken:()=>this.tokenObject?.getValidToken()})}getUrl(e,t=!0){return t?`${window.location.protocol}//${window.location.hostname}/${e}?redirect_uri=${encodeURIComponent(""+window.location.href)}`:`${window.location.protocol}//${window.location.hostname}/${e}`}setStoreCleanAll(e){this.storeCleanAll=e}logout(e=!1,s=!1){t(`logout(...), Amur ${this.getIsNextrel()?"nextrel":"current"} instance is ${this.hasTokenToDoLogout?"active":"inactive"}`),(this.hasTokenToDoLogout||e)&&(t(`logout(...), Amur ${this.getIsNextrel()?"nextrel":"current"} instance performs logout proper`),clearTimeout(this.timeoutTokenCheck),this.storeCleanAll(),this.env?.cleanupAfterLogout(),window.location.replace(this.getUrl(this.env?.getLogoutPath()||"",s)))}cleanupSessionStorage(e){this.env?.cleanup(),this.addCallbackWhenReady((()=>{e({error:"token_not_available"},0)}))}refreshToken(e){this.env?.setRefreshToken(e),this.tokenObject&&(this.tokenObject.bifrost_token=e)}getTokenObjectIfPresent(e){const t=this.getTokenIfPresentSync(),s=c.cleanBearerToken(t);if(s!==t&&this.env?.updateCookieWithToken(s),!s)return void e(null);let i=null;try{i=this.env?.getPersistedData()}catch{}i||(i={}),this.createTokenObject(i),this.tokenObject&&(this.tokenObject.bifrost_token=s),this.addCallbackWhenReady((()=>{this.activateRefresh(),this.callCallbackIfTokenNotExpired(e)}))}getTokenIfPresentSync(){return this.env?.getTokenIfPresent()||""}createTokenObject(e){this.tokenObject?this.tokenObject.merge(e):this.tokenObject=new i(e)}}const l=105e4,h=new s,u=new class{callback=null;lastActivityinMS=0;refreshLimitMs=6e4;timerId;_timer;logout=[];constructor(e){this.resetLastActivityTime=this.resetLastActivityTime.bind(this),this.userActivityDetected=this.userActivityDetected.bind(this),this.enableInactivityChecker(),this.refreshLimitMs=e}resetLastActivityTime(){this.lastActivityinMS=(new Date).getTime()}setInactivityLimit(e){this.refreshLimitMs=e}addLogoutFn(e){this.logout.push(e)}checkIfTimeisOverAndReset=()=>{if(!this.callback)return;const{lastActivityinMS:e,callback:{cb:t}}=this;(new Date).getTime()-e>this.refreshLimitMs?this.logout.forEach((e=>e())):(t(),this.resetInactivityTimer())};userActivityDetected(){clearTimeout(this._timer),this._timer=setTimeout(this.resetLastActivityTime,60)}enableInactivityChecker(){["scroll","focus","mouseover","click","keypress","touchstart","mousedown"].forEach((e=>document.addEventListener(e,this.userActivityDetected,{capture:!0,passive:!0}))),window.addEventListener("resize",this.userActivityDetected);const e=()=>"hidden"===document.visibilityState&&this.resetInactivityTimer();document.addEventListener("visibilitychange",e,!0),e()}resetInactivityTimer(){if(!this.callback)return;const{callback:{ms:e}}=this;(()=>{clearTimeout(this.timerId),this.timerId=setTimeout(this.checkIfTimeisOverAndReset,e)})()}clearAll(){clearTimeout(this.timerId),this.callback=null,this.lastActivityinMS=0}notifyInactivityAfterMs(e,t){this.callback={ms:e,cb:t},this.resetLastActivityTime(),this.resetInactivityTimer()}}(l),g=()=>h.cleanAll(),d=function(){try{const e=new XMLHttpRequest;e.open("GET","/servertime.txt",!1),e.send(null);const t=e.getAllResponseHeaders(),{0:s}=t.split("\n").filter((e=>0===e.toLowerCase().indexOf("date")));if(s){const e=new Date(s.replace(/(?:\r\n|\r|\n)/g,"").replace("date: ",""));return Math.round((e.valueOf()-(new Date).valueOf())/36e5)}}catch(e){console.info("\nSomething went wrong in retrieveing Server DATE header. We will use clients UTC system date\n"),console.info(e+"\n")}return 0}(),k=new c(u);k.setUtcDateHourDiffer(d),k.setStoreCleanAll(g);const T=new c(u);T.setIsNextrel(),T.setUtcDateHourDiffer(d),T.setStoreCleanAll(g);const f=h,b=k,m=T,p=u;f.setLoaded(!0),b.setLoaded(!0),m.setLoaded(!0),window.ch_axa_webhub_bifrost=Object.freeze(Object.defineProperty(Object.defineProperty({INACTIVITY_TRESHOLD_MS:l,store:f,amur:b,amurNextrel:m,glassPane:p,getAmurInstance:(e=!1)=>e?T:k,getPayload:()=>null,logout:()=>{b.logout(),m.logout()}},"__esModule",{value:!0}),Symbol.toStringTag,{value:"Module"}));
